<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infrastructure Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Color Palette */
            --primary-color: #1f2937;
            --secondary-color: #374151;
            --accent-color: #4f46e5;
            --success-color: #059669;
            --warning-color: #d97706;
            --error-color: #dc2626;
            --maintenance-color: #6366f1;
            --hermes-color: #7c3aed;
            --snapshot-color: #0891b2;
            --restore-color: #0f766e;
            --etl-color: #059669;
            
            /* Backgrounds */
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            
            /* Text Colors */
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            
            /* Borders */
            --border-color: #e5e7eb;
            --border-hover: #d1d5db;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 0;
            box-shadow: var(--shadow-sm);
            width: 100%;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 2rem;
            font-size: 0.875rem;
        }

        /* Status Badge System */
        .status-badge,
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            width: fit-content;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            border: 1px solid transparent;
        }

        .status-indicator {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        /* Status Color Variants */
        .status-healthy, .status-synced, .status-running,
        .status-indicator.healthy {
            background: #f0fdf4;
            color: var(--success-color);
            border-color: #bbf7d0;
        }

        .status-catching.up {
            background: #f0f9ff;
            color: #0369a1;
            border-color: #bae6fd;
        }

        .status-unhealthy, .status-stopped, .status-failed,
        .status-indicator.error {
            background: #fef2f2;
            color: var(--error-color);
            border-color: #fecaca;
        }

        .status-maintenance,
        .status-indicator.maintenance {
            background: #eef2ff;
            color: var(--maintenance-color);
            border-color: #c7d2fe;
        }

        .status-unknown {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            border-color: var(--border-color);
        }

        .status-indicator.warning {
            background: #fffbeb;
            color: var(--warning-color);
            border-color: #fed7aa;
        }

        .status-dot,
        .status-dot-mini {
            border-radius: 50%;
            background-color: currentColor;
        }

        .status-dot {
            width: 8px;
            height: 8px;
        }

        .status-dot-mini {
            width: 6px;
            height: 6px;
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .metric-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-icon {
            width: 1.25rem;
            height: 1.25rem;
            color: var(--accent-color);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .metric-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .progress-bar {
            margin-top: 1rem;
            height: 4px;
            background-color: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success-color);
            transition: width 0.5s ease;
            border-radius: 2px;
        }

        /* Panel System */
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .panel-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-actions {
            display: flex;
            gap: 0.75rem;
        }

        .panel-content {
            padding: 0;
        }

        /* Table Styles */
        .infrastructure-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .infrastructure-table td {
            padding: 1.25rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }

        .infrastructure-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        /* Component Info Styles */
        .node-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .node-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .node-server {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .auto-restore-indicator {
            font-size: 0.7rem;
            color: var(--success-color);
            font-weight: 500;
            margin-top: 0.25rem;
        }

        .status-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .block-height,
        .uptime,
        .response-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Schedule Display */
        .schedule-info,
        .next-run-info {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .schedule-item,
        .next-run-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .schedule-label,
        .next-run-label {
            font-size: 0.625rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .schedule-cron {
            font-size: 0.75rem;
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 0.25rem 0.375rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
        }

        .schedule-empty,
        .next-run-empty {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .next-run-time {
            font-size: 0.75rem;
            color: var(--text-primary);
            font-weight: 500;
            line-height: 1.3;
        }

        /* Button System */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-hover);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }

        .btn-icon {
            padding: 0.5rem;
        }

        /* Button Color Variants */
        .btn-primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-primary:hover:not(:disabled) {
            background: #4338ca;
            border-color: #4338ca;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .btn-success:hover:not(:disabled) {
            background: #047857;
            border-color: #047857;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .btn-warning:hover:not(:disabled) {
            background: #b45309;
            border-color: #b45309;
        }

        .btn-hermes {
            background: var(--hermes-color);
            color: white;
            border-color: var(--hermes-color);
        }

        .btn-hermes:hover:not(:disabled) {
            background: #6d28d9;
            border-color: #6d28d9;
        }

        .btn-snapshot {
            background: var(--snapshot-color);
            color: white;
            border-color: var(--snapshot-color);
        }

        .btn-snapshot:hover:not(:disabled) {
            background: #0e7490;
            border-color: #0e7490;
        }

        .btn-restore {
            background: var(--restore-color);
            color: white;
            border-color: var(--restore-color);
        }

        .btn-restore:hover:not(:disabled) {
            background: #134e4a;
            border-color: #134e4a;
        }

        .btn-state-sync {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .btn-state-sync:hover:not(:disabled) {
            background: #1d4ed8;
            border-color: #1d4ed8;
        }

        .btn-etl {
            background: var(--etl-color);
            color: white;
            border-color: var(--etl-color);
        }

        .btn-etl:hover:not(:disabled) {
            background: #047857;
            border-color: #047857;
        }

        /* Action Dropdown Styles */
        .action-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .dropdown-toggle:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-hover);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 0.25rem);
            min-width: 180px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            overflow: hidden;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.75rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .dropdown-item:hover:not(:disabled) {
            background: var(--bg-tertiary);
        }

        .dropdown-item:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.25rem 0;
        }



        /* Search and Filter Styles */
        .panel-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2.25rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background: var(--bg-secondary);
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem;
            height: 1rem;
            color: var(--text-muted);
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: var(--bg-tertiary);
        }

        .filter-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --border-hover: #4b5563;
        }

        .dark-mode-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .dark-mode-toggle:hover {
            background: var(--bg-tertiary);
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .notification-bell:hover {
            background: var(--bg-tertiary);
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: var(--error-color);
            color: white;
            border-radius: 9999px;
            width: 1rem;
            height: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            font-weight: 600;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 0.5rem);
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .notification-item:hover {
            background: var(--bg-tertiary);
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .notification-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .notification-message {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Collapsible Panel */
        .panel-collapse-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        .panel.collapsed .panel-collapse-btn {
            transform: rotate(-90deg);
        }

        .panel.collapsed .panel-content {
            display: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Snapshot Table */
        .snapshot-table {
            width: 100%;
            border-collapse: collapse;
        }

        .snapshot-table th {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .snapshot-table td {
            padding: 0.875rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .snapshot-table tr:hover {
            background: var(--bg-tertiary);
        }

        /* Block Height Progress */
        .block-progress {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .block-progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .block-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--error-color), var(--warning-color), var(--success-color));
            transition: width 0.5s ease;
        }

        .blocks-behind {
            font-size: 0.7rem;
            color: var(--warning-color);
            font-weight: 500;
        }

        /* Loading & Empty States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: var(--text-muted);
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state-subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .error-state {
            padding: 3rem;
            text-align: center;
            color: var(--error-color);
        }

        /* Alert System */
        .alert {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            border: 1px solid;
        }

        .alert.show {
            opacity: 1;
            transform: translateX(0);
        }

        .alert-success {
            background: #f0fdf4;
            color: var(--success-color);
            border-color: #bbf7d0;
        }

        .alert-warning {
            background: #fffbeb;
            color: var(--warning-color);
            border-color: #fed7aa;
        }

        .alert-error {
            background: #fef2f2;
            color: var(--error-color);
            border-color: #fecaca;
        }

        /* Utility Classes */
        #last-updated {
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 400;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>Infrastructure Console</h1>
            </div>
            <div class="header-status">
                <div class="status-indicator healthy" id="system-status">
                    <div class="status-dot"></div>
                    <span>All Systems Operational</span>
                </div>
                <div id="last-updated">Last updated: Never</div>
                
                <!-- Notification Bell -->
                <div style="position: relative;">
                    <button class="notification-bell" onclick="app.toggleNotifications()" title="Notifications">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                        </svg>
                        <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
                    </button>
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div id="notification-list">
                            <div class="empty-state" style="padding: 2rem;">
                                <div class="empty-state-subtitle">No new notifications</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dark Mode Toggle -->
                <button class="dark-mode-toggle" onclick="app.toggleDarkMode()" title="Toggle Dark Mode">
                    <svg id="dark-mode-icon" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="main-container">


        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Total Components</div>
                    <svg class="metric-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                </div>
                <div class="metric-value" id="total-components">-</div>
                <div class="metric-subtitle" id="components-breakdown">Nodes, Relayers & ETL</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Operational Components</div>
                    <svg class="metric-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                    </svg>
                </div>
                <div class="metric-value" id="healthy-components">-</div>
                <div class="metric-subtitle" id="health-percentage">-% operational</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="health-progress" style="width: 0%"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Uptime Statistics</div>
                    <svg class="metric-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/>
                    </svg>
                </div>
                <div class="metric-value" id="average-uptime">-</div>
                <div class="metric-subtitle" id="uptime-subtitle">Average uptime</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Server Count</div>
                    <svg class="metric-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 002 2H4a2 2 0 01-2-2V5zm3 1h6v4H5V6zm6 6H5v2h6v-2z"/>
                        <path d="M15 7h1a2 2 0 012 2v5.5a1.5 1.5 0 01-3 0V9a1 1 0 00-1-1h-1v4.5a1.5 1.5 0 01-3 0V7z"/>
                    </svg>
                </div>
                <div class="metric-value" id="server-count">-</div>
                <div class="metric-subtitle" id="server-subtitle">Infrastructure servers</div>
            </div>
        </div>

        <!-- Blockchain Nodes Panel -->
        <div class="panel" id="nodes-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <button class="panel-collapse-btn" onclick="app.togglePanel('nodes-panel')">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                    Blockchain Nodes
                </div>
                <div class="panel-actions">
                    <button class="btn btn-secondary btn-sm" onclick="app.refreshNodes()" title="Refresh all node statuses">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/>
                        </svg>
                        Refresh All
                    </button>
                </div>
            </div>
            
            <!-- Search and Filters -->
            <div class="panel-filters">
                <div class="search-box">
                    <svg class="search-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                    <input type="text" class="search-input" id="nodes-search" placeholder="Search nodes by name or server..." oninput="app.filterNodes()">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all" onclick="app.setNodeFilter('all')">All</button>
                    <button class="filter-btn" data-filter="synced" onclick="app.setNodeFilter('synced')">Synced</button>
                    <button class="filter-btn" data-filter="catching-up" onclick="app.setNodeFilter('catching-up')">Catching Up</button>
                    <button class="filter-btn" data-filter="unhealthy" onclick="app.setNodeFilter('unhealthy')">Unhealthy</button>
                    <button class="filter-btn" data-filter="maintenance" onclick="app.setNodeFilter('maintenance')">Maintenance</button>
                </div>
            </div>
            
            <div class="panel-content" id="nodes-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading blockchain nodes...</span>
                </div>
            </div>
        </div>

        <!-- Hermes Relayers Panel -->
        <div class="panel" id="hermes-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <button class="panel-collapse-btn" onclick="app.togglePanel('hermes-panel')">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                    </svg>
                    Hermes Relayers
                </div>
                <div class="panel-actions">
                    <button class="btn btn-secondary btn-sm" onclick="app.refreshHermes()" title="Refresh all Hermes relayer statuses">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/>
                        </svg>
                        Refresh All
                    </button>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="panel-filters">
                <div class="search-box">
                    <svg class="search-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                    <input type="text" class="search-input" id="hermes-search" placeholder="Search Hermes by name or server..." oninput="app.filterHermes()">
                </div>
            </div>
            
            <div class="panel-content" id="hermes-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading Hermes relayers...</span>
                </div>
            </div>
        </div>

        <!-- ETL Services Panel -->
        <div class="panel" id="etl-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <button class="panel-collapse-btn" onclick="app.togglePanel('etl-panel')">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM4.586 8L6 9.414 7.414 8H4.586zM5 12a1 1 0 100 2h10a1 1 0 100-2H5z"/>
                    </svg>
                    ETL Services
                </div>
                <div class="panel-actions">
                    <button class="btn btn-secondary btn-sm" onclick="app.refreshEtl()" title="Refresh all ETL service statuses">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/>
                        </svg>
                        Refresh All
                    </button>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="panel-filters">
                <div class="search-box">
                    <svg class="search-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                    <input type="text" class="search-input" id="etl-search" placeholder="Search ETL services by name..." oninput="app.filterEtl()">
                </div>
            </div>
            
            <div class="panel-content" id="etl-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading ETL services...</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        /**
         * Infrastructure Console Application
         * Modular architecture for better maintainability
         */
        const app = (() => {
            // ============================================================
            // STATE MANAGEMENT
            // ============================================================
            const state = {
                configs: {
                    nodes: {},
                    hermes: {},
                    etl: {}
                },
                data: {
                    nodes: null,
                    hermes: null,
                    etl: null,
                    maintenance: null,
                    operations: null,
                    notifications: []
                },
                ui: {
                    isLoading: false,
                    refreshInterval: null,
                    operationsRefreshInterval: null,
                    darkMode: false,
                    nodeFilter: 'all',
                    searchTerms: {
                        nodes: '',
                        hermes: '',
                        etl: ''
                    },
                    collapsedPanels: new Set()
                },
                originalData: {
                    nodes: null,
                    hermes: null,
                    etl: null
                }
            };

            // ============================================================
            // CONSTANTS
            // ============================================================
            const CONFIG = {
                REFRESH_INTERVAL: 30000,
                ALERT_DURATION: 5000,
                SERVER_TIMEZONE_OFFSET: 0 // UTC
            };

            // ============================================================
            // DOM CACHE
            // ============================================================
            const dom = {};

            function cacheDOMElements() {
                dom.systemStatus = document.getElementById('system-status');
                dom.lastUpdated = document.getElementById('last-updated');
                dom.totalComponents = document.getElementById('total-components');
                dom.healthyComponents = document.getElementById('healthy-components');
                dom.componentsBreakdown = document.getElementById('components-breakdown');
                dom.healthPercentage = document.getElementById('health-percentage');
                dom.healthProgress = document.getElementById('health-progress');
                dom.averageUptime = document.getElementById('average-uptime');
                dom.uptimeSubtitle = document.getElementById('uptime-subtitle');
                dom.serverCount = document.getElementById('server-count');
                dom.serverSubtitle = document.getElementById('server-subtitle');
                dom.nodesContainer = document.getElementById('nodes-container');
                dom.hermesContainer = document.getElementById('hermes-container');
                dom.etlContainer = document.getElementById('etl-container');
            }

            // ============================================================
            // API CLIENT
            // ============================================================
            const api = {
                async fetchJSON(url) {
                    const response = await fetch(url);
                    return response.json();
                },

                async loadConfigs() {
                    const [nodes, hermes, etl] = await Promise.all([
                        this.fetchJSON('/api/config/nodes'),
                        this.fetchJSON('/api/config/hermes'),
                        this.fetchJSON('/api/config/etl')
                    ]);
                    
                    state.configs.nodes = nodes.success ? (nodes.data.nodes || {}) : {};
                    state.configs.hermes = hermes.success ? (hermes.data.hermes || {}) : {};
                    state.configs.etl = etl.success ? (etl.data.etl || {}) : {};
                },

                async loadHealthData() {
                    const [nodes, hermes, etl, maintenance] = await Promise.all([
                        this.fetchJSON('/api/health/nodes?include_disabled=true'),
                        this.fetchJSON('/api/health/hermes'),
                        this.fetchJSON('/api/health/etl?include_disabled=true'),
                        this.fetchJSON('/api/operations/active')
                    ]);

                    state.data.nodes = nodes.success ? nodes.data : null;
                    state.data.hermes = hermes.success ? hermes.data : null;
                    state.data.etl = etl.success ? etl.data : null;
                    state.data.maintenance = maintenance.success ? maintenance.data : null;
                }
            };

            // ============================================================
            // UTILITIES
            // ============================================================
            const utils = {
                formatName(name) {
                    if (!name) return name;
                    return name.split('-')
                        .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
                        .join(' ');
                },

                formatTimeAgo(timestamp) {
                    if (!timestamp) return 'Never';
                    const diffMs = Date.now() - new Date(timestamp);
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    
                    const diffHours = Math.floor(diffMins / 60);
                    if (diffHours < 24) return `${diffHours}h ago`;
                    
                    const diffDays = Math.floor(diffHours / 24);
                    return `${diffDays}d ago`;
                },

                getStatusClass(status, type = 'node') {
                    const clean = status.toLowerCase().replace(/\s+/g, '').replace(/[()]/g, '');
                    
                    if (type === 'node') {
                        if (clean === 'synced' || clean === 'healthy') return 'status-synced';
                        if (clean === 'catchingup') return 'status-catching up';
                        if (clean === 'unhealthy') return 'status-unhealthy';
                        if (clean === 'maintenance') return 'status-maintenance';
                    } else if (type === 'hermes') {
                        if (clean.includes('running')) return 'status-running';
                        if (clean.includes('stopped') || clean.includes('failed')) return 'status-stopped';
                    } else if (type === 'etl') {
                        if (clean === 'healthy') return 'status-healthy';
                        if (clean === 'unhealthy') return 'status-unhealthy';
                    }
                    
                    return 'status-unknown';
                },

                getCronSortValue(cronSchedule) {
                    if (!cronSchedule) return 99999;
                    const parts = cronSchedule.trim().split(/\s+/);
                    if (parts.length !== 6) return 99999;
                    const hour = parseInt(parts[2]) || 0;
                    const dayOfWeek = parseInt(parts[5]) || 0;
                    return dayOfWeek * 100 + hour;
                }
            };

            // ============================================================
            // CRON PARSER
            // ============================================================
            const cron = {
                parse(expression) {
                    const parts = expression.trim().split(/\s+/);
                    if (parts.length !== 6) return null;
                    
                    return {
                        second: parts[0],
                        minute: parts[1],
                        hour: parts[2],
                        dayOfMonth: parts[3],
                        month: parts[4],
                        dayOfWeek: parts[5]
                    };
                },

                getNextRun(expression) {
                    const parsed = this.parse(expression);
                    if (!parsed) return null;

                    const now = new Date();
                    const next = new Date(now);

                    // Set seconds
                    next.setUTCSeconds(parsed.second !== '*' ? (parseInt(parsed.second) || 0) : 0, 0);

                    // Set minutes
                    if (parsed.minute !== '*') {
                        const targetMinute = parseInt(parsed.minute);
                        if (targetMinute >= 0 && targetMinute <= 59) {
                            next.setUTCMinutes(targetMinute);
                        }
                    }

                    // Set hours
                    if (parsed.hour !== '*') {
                        const targetHour = parseInt(parsed.hour);
                        if (targetHour >= 0 && targetHour <= 23) {
                            next.setUTCHours(targetHour);
                        }
                    }

                    // Handle day of week (tokio-cron-scheduler: 1=Monday, 2=Tuesday, ..., 7=Sunday)
                    // JavaScript: 0=Sunday, 1=Monday, 2=Tuesday, ..., 6=Saturday
                    if (parsed.dayOfWeek !== '*') {
                        const targetDayNum = parseInt(parsed.dayOfWeek);
                        // Convert tokio-cron day (1=Mon, 7=Sun) to JS day (0=Sun, 1=Mon, ...)
                        const targetJSDay = targetDayNum === 7 ? 0 : targetDayNum;
                        const currentJSDay = next.getUTCDay();
                        let daysToAdd = targetJSDay - currentJSDay;

                        if (daysToAdd < 0 || (daysToAdd === 0 && next <= now)) {
                            daysToAdd += 7;
                        }

                        if (daysToAdd > 0) {
                            next.setUTCDate(next.getUTCDate() + daysToAdd);
                        }
                    } else if (next <= now) {
                        next.setUTCDate(next.getUTCDate() + 1);
                    }

                    return next;
                },

                formatNextRun(cronSchedule) {
                    const nextRun = this.getNextRun(cronSchedule);
                    if (!nextRun) return '<div class="next-run-empty">Invalid schedule</div>';

                    const timeString = nextRun.toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        hour12: true 
                    });
                    const dayString = nextRun.toLocaleDateString([], { weekday: 'long' });
                    const dateString = nextRun.toLocaleDateString([], { 
                        day: '2-digit', 
                        month: 'short' 
                    });

                    return `<div class="next-run-time">${timeString}, ${dayString}, ${dateString}</div>`;
                }
            };

            // ============================================================
            // TEMPLATE BUILDERS
            // ============================================================
            const templates = {
                icons: {
                    prune: '<svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 3a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z"/></svg>',
                    snapshot: '<svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm12 12V8l-2 2-2-2v8h4z"/></svg>',
                    restore: '<svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/></svg>',
                    stateSync: '<svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/><circle cx="10" cy="10" r="2" fill="white"/></svg>',
                    refresh: '<svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/></svg>'
                },

                scheduleItem(label, schedule, enabled = true) {
                    if (!enabled) {
                        return `<div class="schedule-item">
                            <div class="schedule-label">${label}</div>
                            <div class="schedule-empty">Disabled</div>
                        </div>`;
                    }
                    return `<div class="schedule-item">
                        <div class="schedule-label">${label}</div>
                        ${schedule ? `<div class="schedule-cron">${schedule}</div>` : '<div class="schedule-empty">Not scheduled</div>'}
                    </div>`;
                },

                nextRunItem(label, schedule, enabled = true) {
                    if (!enabled) {
                        return `<div class="next-run-item">
                            <div class="next-run-label">${label}</div>
                            <div class="next-run-empty">Disabled</div>
                        </div>`;
                    }
                    return `<div class="next-run-item">
                        <div class="next-run-label">${label}</div>
                        ${schedule ? cron.formatNextRun(schedule) : '<div class="next-run-empty">Not scheduled</div>'}
                    </div>`;
                },

                actionButton(type, nodeName, config) {
                    const buttons = {
                        prune: {
                            condition: config.pruning_enabled,
                            class: 'btn-warning',
                            icon: this.icons.prune,
                            title: 'Execute pruning operation - stops node, runs cosmos-pruner, restarts node',
                            onclick: `app.executeNodePruning('${nodeName}')`
                        },
                        snapshot: {
                            condition: config.snapshots_enabled,
                            class: 'btn-snapshot',
                            icon: this.icons.snapshot,
                            title: 'Create network snapshot - stops node, creates compressed backup, restarts node',
                            onclick: `app.executeCreateSnapshot('${nodeName}')`
                        },
                        restore: {
                            condition: config.auto_restore_enabled,
                            class: 'btn-restore',
                            icon: this.icons.restore,
                            title: 'Restore from latest network snapshot - replaces all data, preserves validator state',
                            onclick: `app.executeManualRestore('${nodeName}')`
                        },
                        stateSync: {
                            condition: config.state_sync_enabled,
                            class: 'btn-state-sync',
                            icon: this.icons.stateSync,
                            title: 'Execute state sync - quickly sync from trusted snapshot height, wipes existing data',
                            onclick: `app.executeStateSync('${nodeName}')`
                        }
                    };

                    const btn = buttons[type];
                    if (!btn || !btn.condition) return '';

                    return `<button class="btn btn-icon ${btn.class}" onclick="${btn.onclick}" title="${btn.title}">
                        ${btn.icon}
                    </button>`;
                },

                emptyState(title, subtitle) {
                    return `<div class="empty-state">
                        <div class="empty-state-title">${title}</div>
                        <div class="empty-state-subtitle">${subtitle}</div>
                    </div>`;
                },

                errorState(title, message) {
                    return `<div class="error-state">
                        <div class="empty-state-title">${title}</div>
                        <div class="empty-state-subtitle">${message}</div>
                    </div>`;
                }
            };

            // ============================================================
            // RENDERERS
            // ============================================================
            const renderers = {
                renderNodes(nodes) {
                    if (!nodes || nodes.length === 0) {
                        dom.nodesContainer.innerHTML = templates.emptyState(
                            'No blockchain nodes configured',
                            'Add node configurations to get started'
                        );
                        return;
                    }

                    const sorted = [...nodes].sort((a, b) => {
                        const configA = state.configs.nodes[a.node_name] || {};
                        const configB = state.configs.nodes[b.node_name] || {};
                        return utils.getCronSortValue(configA.pruning_schedule) - 
                               utils.getCronSortValue(configB.pruning_schedule);
                    });

                    const rows = sorted.map(node => {
                        const config = state.configs.nodes[node.node_name] || {};
                        return `<tr>
                            <td style="width: 20%;">
                                <div class="node-info">
                                    <div class="node-name">${utils.formatName(node.node_name)}</div>
                                    <div class="node-server">${node.server_host}</div>
                                    ${config.auto_restore_enabled ? '<div class="auto-restore-indicator">Auto restore</div>' : ''}
                                </div>
                            </td>
                            <td style="width: 20%;">
                                <div class="status-info">
                                    <div class="status-badge ${utils.getStatusClass(node.status, 'node')}">
                                        <div class="status-dot-mini"></div>
                                        ${node.status}
                                    </div>
                                    <div class="block-height">Block: ${node.latest_block_height ? node.latest_block_height.toLocaleString() : 'N/A'}</div>
                                </div>
                            </td>
                            <td style="width: 20%;">
                                <div class="schedule-info">
                                    ${templates.scheduleItem('Pruning', config.pruning_schedule)}
                                    ${templates.scheduleItem('Snapshot', config.snapshot_schedule, config.snapshots_enabled)}
                                </div>
                            </td>
                            <td style="width: 20%;">
                                <div class="next-run-info">
                                    ${templates.nextRunItem('Next Pruning', config.pruning_schedule)}
                                    ${templates.nextRunItem('Next Snapshot', config.snapshot_schedule, config.snapshots_enabled)}
                                </div>
                            </td>
                            <td style="width: 20%;">
                                <div class="action-buttons">
                                    ${templates.actionButton('prune', node.node_name, config)}
                                    ${templates.actionButton('snapshot', node.node_name, config)}
                                    ${templates.actionButton('restore', node.node_name, config)}
                                    ${templates.actionButton('stateSync', node.node_name, config)}
                                </div>
                            </td>
                        </tr>`;
                    }).join('');

                    dom.nodesContainer.innerHTML = `<table class="infrastructure-table"><tbody>${rows}</tbody></table>`;
                },

                renderHermes(instances) {
                    if (!instances || instances.length === 0) {
                        dom.hermesContainer.innerHTML = templates.emptyState(
                            'No Hermes relayers configured',
                            'Add Hermes configurations to get started'
                        );
                        return;
                    }

                    const sorted = [...instances].sort((a, b) => {
                        const configA = state.configs.hermes[a.name] || {};
                        const configB = state.configs.hermes[b.name] || {};
                        return utils.getCronSortValue(configA.restart_schedule) - 
                               utils.getCronSortValue(configB.restart_schedule);
                    });

                    const rows = sorted.map(hermes => {
                        const config = state.configs.hermes[hermes.name] || {};
                        return `<tr>
                            <td style="width: 25%;">
                                <div class="node-info">
                                    <div class="node-name">${utils.formatName(hermes.name)}</div>
                                    <div class="node-server">${hermes.server_host}</div>
                                </div>
                            </td>
                            <td style="width: 20%;">
                                <div class="status-badge ${utils.getStatusClass(hermes.status, 'hermes')}">
                                    <div class="status-dot-mini"></div>
                                    ${hermes.status.replace(/[()]/g, '')}
                                </div>
                            </td>
                            <td style="width: 20%;">
                                <div class="schedule-info">
                                    ${templates.scheduleItem('Restart Schedule', config.restart_schedule)}
                                </div>
                            </td>
                            <td style="width: 15%;">
                                <div class="next-run-info">
                                    ${templates.nextRunItem('Next Restart', config.restart_schedule)}
                                </div>
                            </td>
                            <td style="width: 20%;">
                                <div class="action-buttons">
                                    <button class="btn btn-icon btn-hermes" onclick="app.executeHermesRestart('${hermes.name}')" title="Restart Hermes relayer">
                                        ${templates.icons.restore}
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    }).join('');

                    dom.hermesContainer.innerHTML = `<table class="infrastructure-table"><tbody>${rows}</tbody></table>`;
                },

                renderEtl(services) {
                    if (!services || services.length === 0) {
                        dom.etlContainer.innerHTML = templates.emptyState(
                            'No ETL services configured',
                            'Add ETL service configurations to get started'
                        );
                        return;
                    }

                    const rows = services.map(etl => `<tr>
                        <td style="width: 25%;">
                            <div class="node-info">
                                <div class="node-name">${utils.formatName(etl.service_name)}</div>
                                <div class="node-server">${etl.server_host}</div>
                                ${etl.description ? `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">${etl.description}</div>` : ''}
                            </div>
                        </td>
                        <td style="width: 20%;">
                            <div class="status-info">
                                <div class="status-badge ${utils.getStatusClass(etl.status, 'etl')}">
                                    <div class="status-dot-mini"></div>
                                    ${etl.status}
                                </div>
                                ${etl.status_code ? `<div class="block-height">Status: ${etl.status_code}</div>` : ''}
                            </div>
                        </td>
                        <td style="width: 25%;">
                            <div class="node-info">
                                <div style="font-size: 0.75rem; color: var(--text-muted); font-family: monospace;">${etl.service_url}</div>
                                ${etl.response_time_ms ? `<div class="response-time">${etl.response_time_ms}ms response</div>` : ''}
                            </div>
                        </td>
                        <td style="width: 20%;">
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${utils.formatTimeAgo(etl.last_check)}</div>
                            ${etl.error_message ? `<div style="font-size: 0.7rem; color: var(--error-color); margin-top: 0.25rem;">${etl.error_message}</div>` : ''}
                        </td>
                        <td style="width: 10%;">
                            <div class="action-buttons">
                                <button class="btn btn-icon btn-etl" onclick="app.refreshEtlService('${etl.service_name}')" title="Refresh ETL service health">
                                    ${templates.icons.refresh}
                                </button>
                            </div>
                        </td>
                    </tr>`).join('');

                    dom.etlContainer.innerHTML = `<table class="infrastructure-table"><tbody>${rows}</tbody></table>`;
                }
            };

            // ============================================================
            // METRICS UPDATER
            // ============================================================
            const metrics = {
                update() {
                    this.updateHealth();
                    this.updateUptime();
                    this.updateServers();
                    this.updateSystemStatus();
                },

                updateHealth() {
                    const counts = this.getCounts();
                    const healthPct = counts.total > 0 ? Math.round((counts.operational / counts.total) * 100) : 0;

                    dom.totalComponents.textContent = counts.total;
                    dom.healthyComponents.textContent = counts.operational;
                    dom.componentsBreakdown.textContent = `${counts.nodes} Nodes, ${counts.hermes} Relayers & ${counts.etl} ETL`;
                    dom.healthPercentage.textContent = `${healthPct}% operational`;
                    dom.healthProgress.style.width = `${healthPct}%`;
                },

                updateUptime() {
                    const counts = this.getCounts();
                    const uptimePct = counts.total > 0 ? Math.round((counts.operational / counts.total) * 100) : 0;

                    dom.averageUptime.textContent = `${uptimePct}%`;
                    dom.uptimeSubtitle.textContent = 'System availability';
                },

                updateServers() {
                    const servers = new Set();
                    
                    [state.data.nodes, state.data.hermes, state.data.etl].forEach(dataset => {
                        if (dataset) {
                            dataset.forEach(item => {
                                if (item.server_host) servers.add(item.server_host);
                            });
                        }
                    });

                    dom.serverCount.textContent = servers.size;
                    dom.serverSubtitle.textContent = 'Infrastructure servers';
                },

                updateSystemStatus() {
                    const counts = this.getCounts();
                    const healthPct = counts.total > 0 ? Math.round((counts.operational / counts.total) * 100) : 0;

                    if (counts.maintenance > 0) {
                        dom.systemStatus.className = 'status-indicator maintenance';
                        dom.systemStatus.querySelector('span').textContent = 
                            `${counts.maintenance} System${counts.maintenance === 1 ? '' : 's'} in Maintenance`;
                    } else if (healthPct === 100) {
                        dom.systemStatus.className = 'status-indicator healthy';
                        dom.systemStatus.querySelector('span').textContent = 'All Systems Operational';
                    } else if (healthPct >= 80) {
                        dom.systemStatus.className = 'status-indicator warning';
                        dom.systemStatus.querySelector('span').textContent = 'Minor Issues Detected';
                    } else {
                        dom.systemStatus.className = 'status-indicator error';
                        dom.systemStatus.querySelector('span').textContent = 'System Issues Detected';
                    }
                },

                getCounts() {
                    const nodes = state.data.nodes || [];
                    const hermes = state.data.hermes || [];
                    const etl = state.data.etl || [];

                    const operationalNodes = nodes.filter(n => {
                        const s = n.status.toLowerCase();
                        return s === 'synced' || s === 'catching up' || s === 'healthy';
                    }).length;

                    const operationalHermes = hermes.filter(h => 
                        utils.getStatusClass(h.status, 'hermes') === 'status-running'
                    ).length;

                    const operationalEtl = etl.filter(e => 
                        e.status.toLowerCase() === 'healthy'
                    ).length;

                    const maintenanceNodes = nodes.filter(n => 
                        n.status.toLowerCase() === 'maintenance'
                    ).length;

                    return {
                        nodes: nodes.length,
                        hermes: hermes.length,
                        etl: etl.length,
                        total: nodes.length + hermes.length + etl.length,
                        operational: operationalNodes + operationalHermes + operationalEtl,
                        maintenance: maintenanceNodes
                    };
                }
            };

            // ============================================================
            // UI HELPERS
            // ============================================================
            const ui = {
                showAlert(message, type = 'success') {
                    const alert = document.createElement('div');
                    alert.className = `alert alert-${type}`;
                    alert.textContent = message;
                    document.body.appendChild(alert);

                    setTimeout(() => alert.classList.add('show'), 100);
                    setTimeout(() => {
                        alert.classList.remove('show');
                        setTimeout(() => alert.remove(), 300);
                    }, CONFIG.ALERT_DURATION);
                },

                updateLastUpdated() {
                    dom.lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                },

                confirm(title, message) {
                    return window.confirm(`${title}\n\n${message}`);
                }
            };

            // ============================================================
            // PUBLIC API
            // ============================================================
            return {
                async init() {
                    cacheDOMElements();
                    
                    // Load saved preferences
                    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
                    if (savedDarkMode) {
                        this.toggleDarkMode();
                    }
                    
                    const savedCollapsed = localStorage.getItem('collapsedPanels');
                    if (savedCollapsed) {
                        try {
                            const collapsed = JSON.parse(savedCollapsed);
                            collapsed.forEach(panelId => {
                                state.ui.collapsedPanels.add(panelId);
                                const panel = document.getElementById(panelId);
                                if (panel) panel.classList.add('collapsed');
                            });
                        } catch (e) {}
                    }
                    
                    await this.loadAllData();
                    this.startAutoRefresh();
                    
                    // Close dropdowns when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.notification-bell') && !e.target.closest('.notification-dropdown')) {
                            document.getElementById('notification-dropdown').classList.remove('show');
                        }
                    });
                },

                async loadAllData() {
                    if (state.ui.isLoading) return;
                    state.ui.isLoading = true;

                    try {
                        await api.loadConfigs();
                        await api.loadHealthData();
                        
                        renderers.renderNodes(state.data.nodes);
                        renderers.renderHermes(state.data.hermes);
                        renderers.renderEtl(state.data.etl);
                        
                        metrics.update();
                        ui.updateLastUpdated();
                    } catch (error) {
                        console.error('Failed to load data:', error);
                        ui.showAlert('Failed to load data: ' + error.message, 'error');
                    } finally {
                        state.ui.isLoading = false;
                    }
                },

                startAutoRefresh() {
                    if (state.ui.refreshInterval) {
                        clearInterval(state.ui.refreshInterval);
                    }
                    state.ui.refreshInterval = setInterval(() => this.loadAllData(), CONFIG.REFRESH_INTERVAL);
                },

                // Public refresh methods
                async refreshNodes() {
                    ui.showAlert('Refreshing nodes...', 'warning');
                    await api.loadHealthData();
                    renderers.renderNodes(state.data.nodes);
                    metrics.update();
                    ui.showAlert('Nodes refreshed', 'success');
                },

                async refreshHermes() {
                    ui.showAlert('Refreshing Hermes...', 'warning');
                    await api.loadHealthData();
                    renderers.renderHermes(state.data.hermes);
                    metrics.update();
                    ui.showAlert('Hermes refreshed', 'success');
                },

                async refreshEtl() {
                    ui.showAlert('Refreshing ETL services...', 'warning');
                    await api.loadHealthData();
                    renderers.renderEtl(state.data.etl);
                    metrics.update();
                    ui.showAlert('ETL services refreshed', 'success');
                },

                async refreshEtlService(serviceName) {
                    try {
                        ui.showAlert(`Refreshing ${utils.formatName(serviceName)}...`, 'warning');
                        await api.fetchJSON(`/api/health/etl/${serviceName}`);
                        await api.loadHealthData();
                        renderers.renderEtl(state.data.etl);
                        ui.showAlert(`${utils.formatName(serviceName)} refreshed`, 'success');
                    } catch (error) {
                        ui.showAlert(`Failed to refresh: ${error.message}`, 'error');
                    }
                },

                // Action methods
                async executeCreateSnapshot(nodeName) {
                    const name = utils.formatName(nodeName);
                    if (!ui.confirm('Create Snapshot Confirmation',
                        `Create snapshot for ${name}?\n\n` +
                        'This will stop the node service\n' +
                        'Data will be compressed\n' +
                        'Service will be restarted\n' +
                        'This may take 30-120 minutes\n\n' +
                        'Proceed with snapshot creation?')) return;

                    try {
                        ui.showAlert(`Creating snapshot for ${name}...`, 'warning');
                        const response = await fetch(`/api/snapshots/${nodeName}/create`, {
                            method: 'POST'
                        });
                        const data = await response.json();
                        if (data.success) {
                            ui.showAlert(`Snapshot created for ${name}`, 'success');
                            await this.loadAllData();
                        } else {
                            throw new Error(data.message || 'Snapshot creation failed');
                        }
                    } catch (error) {
                        ui.showAlert(`Failed to create snapshot: ${error.message}`, 'error');
                    }
                },

                async executeNodePruning(nodeName) {
                    const name = utils.formatName(nodeName);
                    if (!ui.confirm('Execute Pruning Confirmation',
                        `Start pruning for ${name}?\n\n` +
                        'This will:\n' +
                        '- Stop the node service\n' +
                        '- Run the cosmos-pruner tool\n' +
                        '- Start the service after completion\n' +
                        '- May take several hours\n\n' +
                        'Proceed with pruning?')) return;

                    try {
                        ui.showAlert(`Starting pruning for ${name}...`, 'warning');
                        const response = await fetch(`/api/maintenance/nodes/${nodeName}/prune`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await response.json();
                        if (data.success) {
                            ui.showAlert(`Pruning started for ${name}`, 'success');
                            await this.loadAllData();
                        } else {
                            throw new Error(data.message || 'Pruning failed');
                        }
                    } catch (error) {
                        ui.showAlert(`Failed to start pruning: ${error.message}`, 'error');
                    }
                },

                async executeManualRestore(nodeName) {
                    const name = utils.formatName(nodeName);
                    if (!ui.confirm('Restore from Snapshot Confirmation',
                        `Restore ${name} from latest snapshot?\n\n` +
                        'WARNING: This will:\n' +
                        '- Stop the node service\n' +
                        '- Delete ALL current data & wasm directories\n' +
                        '- Extract latest snapshot to replace data\n' +
                        '- Restore validator state\n' +
                        '- Start the service after completion\n' +
                        '- May take 30-60 minutes\n\n' +
                        'This action CANNOT BE UNDONE.\n\n' +
                        'Proceed with restore?')) return;

                    try {
                        ui.showAlert(`Restoring ${name}...`, 'warning');
                        const response = await fetch(`/api/snapshots/${nodeName}/restore`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await response.json();
                        if (data.success) {
                            ui.showAlert(`${name} restored successfully`, 'success');
                            await this.loadAllData();
                        } else {
                            throw new Error(data.message || 'Restore failed');
                        }
                    } catch (error) {
                        ui.showAlert(`Failed to restore: ${error.message}`, 'error');
                    }
                },

                async executeStateSync(nodeName) {
                    const name = utils.formatName(nodeName);
                    if (!ui.confirm('Execute State Sync Confirmation',
                        `Execute state sync for ${name}?\n\n` +
                        'WARNING: This will:\n' +
                        '- Stop the node service\n' +
                        '- Fetch trusted height and hash from RPC\n' +
                        '- Update config.toml with state sync parameters\n' +
                        '- Execute unsafe-reset-all (WIPES ALL DATA)\n' +
                        '- Clean WASM cache\n' +
                        '- Start service and wait for sync\n' +
                        '- May take 10-30 minutes\n\n' +
                        'This action CANNOT BE UNDONE.\n\n' +
                        'Proceed with state sync?')) return;

                    try {
                        ui.showAlert(`Starting state sync for ${name}...`, 'warning');
                        const response = await fetch(`/api/state-sync/${nodeName}/execute`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await response.json();
                        if (data.success) {
                            ui.showAlert(`State sync started for ${name}`, 'success');
                            await this.loadAllData();
                        } else {
                            throw new Error(data.message || 'State sync failed');
                        }
                    } catch (error) {
                        ui.showAlert(`Failed to start state sync: ${error.message}`, 'error');
                    }
                },

                async executeHermesRestart(hermesName) {
                    const name = utils.formatName(hermesName);
                    if (!ui.confirm('Restart Hermes Confirmation',
                        `Restart ${name}?\n\n` +
                        'This will stop and start the Hermes relayer\n' +
                        'The relayer will be temporarily unavailable\n\n' +
                        'Proceed with restart?')) return;

                    try {
                        ui.showAlert(`Restarting ${name}...`, 'warning');
                        const response = await fetch(`/api/maintenance/hermes/${hermesName}/restart`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await response.json();
                        if (data.success) {
                            ui.showAlert(`${name} restarted successfully`, 'success');
                            await this.loadAllData();
                        } else {
                            throw new Error(data.message || 'Restart failed');
                        }
                    } catch (error) {
                        ui.showAlert(`Failed to restart: ${error.message}`, 'error');
                    }
                },

                // ============================================================
                // NEW: DARK MODE
                // ============================================================
                toggleDarkMode() {
                    state.ui.darkMode = !state.ui.darkMode;
                    document.body.classList.toggle('dark-mode', state.ui.darkMode);
                    localStorage.setItem('darkMode', state.ui.darkMode);
                    
                    // Update icon
                    const icon = document.getElementById('dark-mode-icon');
                    if (state.ui.darkMode) {
                        icon.innerHTML = '<path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/>';
                    } else {
                        icon.innerHTML = '<path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>';
                    }
                },

                // ============================================================
                // NEW: NOTIFICATIONS
                // ============================================================
                toggleNotifications() {
                    const dropdown = document.getElementById('notification-dropdown');
                    dropdown.classList.toggle('show');
                },

                addNotification(title, message, type = 'info') {
                    const notification = {
                        id: Date.now(),
                        title,
                        message,
                        type,
                        timestamp: new Date(),
                        read: false
                    };
                    
                    state.data.notifications.unshift(notification);
                    if (state.data.notifications.length > 50) {
                        state.data.notifications = state.data.notifications.slice(0, 50);
                    }
                    
                    this.updateNotificationUI();
                },

                updateNotificationUI() {
                    const unreadCount = state.data.notifications.filter(n => !n.read).length;
                    const badge = document.getElementById('notification-badge');
                    const list = document.getElementById('notification-list');
                    
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                    
                    if (state.data.notifications.length === 0) {
                        list.innerHTML = '<div class="empty-state" style="padding: 2rem;"><div class="empty-state-subtitle">No new notifications</div></div>';
                    } else {
                        list.innerHTML = state.data.notifications.slice(0, 10).map(n => `
                            <div class="notification-item" onclick="app.markNotificationRead(${n.id})" style="${n.read ? 'opacity: 0.6;' : ''}">
                                <div class="notification-header">
                                    <div class="notification-title">${n.title}</div>
                                    <div class="notification-time">${utils.formatTimeAgo(n.timestamp)}</div>
                                </div>
                                <div class="notification-message">${n.message}</div>
                            </div>
                        `).join('');
                    }
                },

                markNotificationRead(id) {
                    const notification = state.data.notifications.find(n => n.id === id);
                    if (notification) {
                        notification.read = true;
                        this.updateNotificationUI();
                    }
                },

                // ============================================================
                // NEW: PANEL COLLAPSE
                // ============================================================
                togglePanel(panelId) {
                    const panel = document.getElementById(panelId);
                    panel.classList.toggle('collapsed');
                    
                    if (panel.classList.contains('collapsed')) {
                        state.ui.collapsedPanels.add(panelId);
                    } else {
                        state.ui.collapsedPanels.delete(panelId);
                    }
                    
                    localStorage.setItem('collapsedPanels', JSON.stringify([...state.ui.collapsedPanels]));
                },



                // ============================================================
                // NEW: FILTERS & SEARCH
                // ============================================================
                setNodeFilter(filter) {
                    state.ui.nodeFilter = filter;
                    
                    // Update button states
                    document.querySelectorAll('#nodes-panel .filter-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.filter === filter);
                    });
                    
                    this.applyNodeFilters();
                },

                filterNodes() {
                    state.ui.searchTerms.nodes = document.getElementById('nodes-search').value.toLowerCase();
                    this.applyNodeFilters();
                },

                applyNodeFilters() {
                    if (!state.originalData.nodes) {
                        state.originalData.nodes = state.data.nodes;
                    }
                    
                    let filtered = state.originalData.nodes;
                    
                    // Apply status filter
                    if (state.ui.nodeFilter !== 'all') {
                        filtered = filtered.filter(node => {
                            const status = node.status.toLowerCase();
                            if (state.ui.nodeFilter === 'synced') return status === 'synced';
                            if (state.ui.nodeFilter === 'catching-up') return status === 'catching up';
                            if (state.ui.nodeFilter === 'unhealthy') return status === 'unhealthy';
                            if (state.ui.nodeFilter === 'maintenance') return status === 'maintenance';
                            return true;
                        });
                    }
                    
                    // Apply search
                    if (state.ui.searchTerms.nodes) {
                        filtered = filtered.filter(node => 
                            node.node_name.toLowerCase().includes(state.ui.searchTerms.nodes) ||
                            node.server_host.toLowerCase().includes(state.ui.searchTerms.nodes)
                        );
                    }
                    
                    state.data.nodes = filtered;
                    renderers.renderNodes(filtered);
                },

                filterHermes() {
                    state.ui.searchTerms.hermes = document.getElementById('hermes-search').value.toLowerCase();
                    
                    if (!state.originalData.hermes) {
                        state.originalData.hermes = state.data.hermes;
                    }
                    
                    const filtered = state.originalData.hermes.filter(hermes =>
                        hermes.name.toLowerCase().includes(state.ui.searchTerms.hermes) ||
                        hermes.server_host.toLowerCase().includes(state.ui.searchTerms.hermes)
                    );
                    
                    state.data.hermes = filtered;
                    renderers.renderHermes(filtered);
                },

                filterEtl() {
                    state.ui.searchTerms.etl = document.getElementById('etl-search').value.toLowerCase();
                    
                    if (!state.originalData.etl) {
                        state.originalData.etl = state.data.etl;
                    }
                    
                    const filtered = state.originalData.etl.filter(etl =>
                        etl.service_name.toLowerCase().includes(state.ui.searchTerms.etl)
                    );
                    
                    state.data.etl = filtered;
                    renderers.renderEtl(filtered);
                },

                // ============================================================
                // ============================================================
                // NEW: SNAPSHOT MODAL
                // ============================================================
                async openSnapshotModal(nodeName) {
                    const modal = document.getElementById('snapshot-modal');
                    const title = document.getElementById('snapshot-modal-title');
                    const body = document.getElementById('snapshot-modal-body');
                    
                    title.textContent = `Snapshots for ${utils.formatName(nodeName)}`;
                    modal.classList.add('show');
                    
                    try {
                        const data = await api.fetchJSON(`/api/snapshots/${nodeName}/list`);
                        if (data.success && data.data.length > 0) {
                            body.innerHTML = `
                                <table class="snapshot-table">
                                    <thead>
                                        <tr>
                                            <th>Filename</th>
                                            <th>Size</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.data.map(snap => `
                                            <tr>
                                                <td>${snap.filename}</td>
                                                <td>${this.formatSize(snap.size_bytes)}</td>
                                                <td>${new Date(snap.created_at).toLocaleString()}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-restore" onclick="app.restoreSnapshot('${nodeName}', '${snap.filename}')">Restore</button>
                                                    <button class="btn btn-sm" onclick="app.deleteSnapshot('${nodeName}', '${snap.filename}')">Delete</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                        } else {
                            body.innerHTML = '<div class="empty-state">No snapshots available</div>';
                        }
                    } catch (error) {
                        body.innerHTML = `<div class="error-state">Failed to load snapshots: ${error.message}</div>`;
                    }
                },

                closeSnapshotModal() {
                    document.getElementById('snapshot-modal').classList.remove('show');
                },

                formatSize(bytes) {
                    if (!bytes) return 'N/A';
                    const gb = bytes / 1024 / 1024 / 1024;
                    return gb > 1 ? `${gb.toFixed(2)} GB` : `${(bytes / 1024 / 1024).toFixed(2)} MB`;
                },

                async restoreSnapshot(nodeName, filename) {
                    if (!confirm(`Restore ${filename}? This will replace all data!`)) return;
                    
                    try {
                        ui.showAlert('Starting restore...', 'warning');
                        const response = await fetch(`/api/snapshots/${nodeName}/restore`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename })
                        });
                        const data = await response.json();
                        if (data.success) {
                            ui.showAlert('Restore started', 'success');
                            this.closeSnapshotModal();
                        }
                    } catch (error) {
                        ui.showAlert(`Restore failed: ${error.message}`, 'error');
                    }
                },

                async deleteSnapshot(nodeName, filename) {
                    if (!confirm(`Delete ${filename}? This cannot be undone!`)) return;
                    
                    try {
                        const response = await fetch(`/api/snapshots/${nodeName}/${filename}`, {
                            method: 'DELETE'
                        });
                        const data = await response.json();
                        if (data.success) {
                            ui.showAlert('Snapshot deleted', 'success');
                            await this.openSnapshotModal(nodeName);
                        }
                    } catch (error) {
                        ui.showAlert(`Delete failed: ${error.message}`, 'error');
                    }
                }
            };
        })();

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
    
    <!-- Snapshot Management Modal -->
    <div class="modal" id="snapshot-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="snapshot-modal-title">Manage Snapshots</h2>
                <button class="modal-close" onclick="app.closeSnapshotModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="snapshot-modal-body">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading snapshots...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="app.closeSnapshotModal()">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
