<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Infrastructure Management Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --primary-color: #1a365d;
            --secondary-color: #2d3748;
            --accent-color: #3182ce;
            --success-color: #38a169;
            --warning-color: #d69e2e;
            --error-color: #e53e3e;
            --maintenance-color: #3182ce;
            --hermes-color: #8b5cf6;
            --snapshot-color: #9f7aea;
            --cancel-color: #e53e3e;
            --bg-primary: #f7fafc;
            --bg-secondary: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }
        .header-status {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.875rem;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        .status-indicator.healthy {
            background-color: rgba(56, 161, 105, 0.1);
            color: var(--success-color);
        }
        .status-indicator.warning {
            background-color: rgba(214, 158, 46, 0.1);
            color: var(--warning-color);
        }
        .status-indicator.error {
            background-color: rgba(229, 62, 62, 0.1);
            color: var(--error-color);
        }
        .status-indicator.maintenance {
            background-color: rgba(49, 130, 206, 0.1);
            color: var(--maintenance-color);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
        }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .metric-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .metric-icon {
            width: 1.25rem;
            height: 1.25rem;
            color: var(--text-muted);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }
        .metric-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .panel-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        .panel-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        .btn:hover {
            background: #f7fafc;
            border-color: var(--text-muted);
        }
        .btn:disabled {
            background: #f7fafc;
            color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn:disabled:hover {
            background: #f7fafc;
            border-color: var(--border-color);
        }
        .btn-primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: #2c5aa0;
            border-color: #2c5aa0;
        }
        .btn-success {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background: #2f855a;
            border-color: #2f855a;
        }
        .btn-warning {
            background: rgba(214, 158, 46, 0.1);
            border-color: rgba(214, 158, 46, 0.2);
            color: var(--warning-color);
        }
        .btn-warning:hover:not(:disabled) {
            background: rgba(214, 158, 46, 0.15);
        }
        .btn-hermes {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.2);
            color: var(--hermes-color);
        }
        .btn-hermes:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.15);
        }
        .btn-snapshot {
            background: rgba(159, 122, 234, 0.1);
            border-color: rgba(159, 122, 234, 0.2);
            color: var(--snapshot-color);
        }
        .btn-snapshot:hover:not(:disabled) {
            background: rgba(159, 122, 234, 0.15);
        }
        .btn-cancel {
            background: rgba(229, 62, 62, 0.1);
            border-color: rgba(229, 62, 62, 0.2);
            color: var(--cancel-color);
        }
        .btn-cancel:hover:not(:disabled) {
            background: rgba(229, 62, 62, 0.15);
        }
        .btn-icon {
            padding: 0.5rem;
            min-width: 2.5rem;
            min-height: 2.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .btn-icon svg {
            width: 16px;
            height: 16px;
        }
        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            z-index: 1000;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }
        .btn-icon:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .panel-content {
            padding: 1.5rem;
        }
        .infrastructure-table {
            width: 100%;
            border-collapse: collapse;
        }
        .infrastructure-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            vertical-align: top;
        }
        .infrastructure-table tr:hover {
            background-color: #f7fafc;
        }
        .node-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-healthy {
            background-color: rgba(56, 161, 105, 0.1);
            color: var(--success-color);
        }
        .status-unhealthy {
            background-color: rgba(229, 62, 62, 0.1);
            color: var(--error-color);
        }
        .status-unknown {
            background-color: rgba(214, 158, 46, 0.1);
            color: var(--warning-color);
        }
        .status-maintenance {
            background-color: rgba(49, 130, 206, 0.1);
            color: var(--maintenance-color);
        }
        .status-active {
            background-color: rgba(56, 161, 105, 0.1);
            color: var(--success-color);
        }
        .status-inactive {
            background-color: rgba(229, 62, 62, 0.1);
            color: var(--error-color);
        }
        .status-dot-small {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: currentColor;
        }
        .maintenance-details {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(49, 130, 206, 0.05);
            border: 1px solid rgba(49, 130, 206, 0.1);
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }
        .maintenance-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .maintenance-progress-bar {
            flex: 1;
            height: 0.375rem;
            background: rgba(49, 130, 206, 0.1);
            border-radius: 0.1875rem;
            overflow: hidden;
        }
        .maintenance-progress-fill {
            height: 100%;
            background: var(--maintenance-color);
            transition: width 0.3s ease-in-out;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .maintenance-progress-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
        }
        .snapshot-info {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            padding: 0.375rem;
            background: rgba(159, 122, 234, 0.05);
            border: 1px solid rgba(159, 122, 234, 0.1);
            border-radius: 0.25rem;
        }
        .snapshot-features {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }
        .snapshot-feature {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
            background: rgba(159, 122, 234, 0.1);
            color: var(--snapshot-color);
        }
        .block-height {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .server-name {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        .component-name-primary {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        .component-name-technical {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'Monaco', 'Consolas', monospace;
        }
        .error-message {
            font-size: 0.75rem;
            color: var(--error-color);
            margin-top: 0.25rem;
            padding: 0.375rem;
            background: rgba(229, 62, 62, 0.05);
            border-radius: 0.25rem;
        }
        .schedule-info {
            font-size: 0.75rem;
        }
        .schedule-readable {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        .schedule-cron {
            color: var(--text-muted);
            font-family: 'Monaco', 'Consolas', monospace;
        }
        .multiple-schedules {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .schedule-item {
            padding: 0.5rem;
            background: rgba(49, 130, 206, 0.05);
            border: 1px solid rgba(49, 130, 206, 0.1);
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        .schedule-item.snapshot {
            background: rgba(159, 122, 234, 0.05);
            border-color: rgba(159, 122, 234, 0.1);
        }
        .schedule-type {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        .schedule-details {
            color: var(--text-muted);
        }
        .next-run {
            font-size: 0.75rem;
        }
        .next-run-time {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        .next-run-countdown {
            color: var(--text-muted);
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background-color: var(--border-color);
            border-radius: 0.25rem;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
            transition: width 0.3s ease-in-out;
        }
        .alert {
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid;
            margin-bottom: 1rem;
        }
        .alert-success {
            background-color: rgba(56, 161, 105, 0.1);
            border-color: rgba(56, 161, 105, 0.2);
            color: var(--success-color);
        }
        .alert-error {
            background-color: rgba(229, 62, 62, 0.1);
            border-color: rgba(229, 62, 62, 0.2);
            color: var(--error-color);
        }
        .alert-warning {
            background-color: rgba(214, 158, 46, 0.1);
            border-color: rgba(214, 158, 46, 0.2);
            color: var(--warning-color);
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        .spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .no-schedule {
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.75rem;
        }
        .hermes-dependent-nodes {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        .uptime-info {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        @media (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            .infrastructure-table td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
        }
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            .header-content {
                padding: 0 1rem;
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            .header-status {
                align-self: stretch;
                justify-content: space-between;
            }
            .panel-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            .action-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }
            .btn-icon {
                padding: 0.375rem;
                min-width: 2rem;
                min-height: 2rem;
            }
            .btn-icon svg {
                width: 14px;
                height: 14px;
            }
            .infrastructure-table {
                font-size: 0.75rem;
            }
            .infrastructure-table td {
                padding: 0.375rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>Infrastructure Management Console</h1>
            </div>
            <div class="header-status">
                <div class="status-indicator healthy" id="system-status">
                    <div class="status-dot"></div>
                    <span>All Systems Operational</span>
                </div>
                <div id="last-updated" style="color: var(--text-muted); font-size: 0.75rem;">
                    Last updated: Never
                </div>
            </div>
        </div>
    </header>
    <main class="main-container">
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Total Components</div>
                    <svg class="metric-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                </div>
                <div class="metric-value" id="total-components">-</div>
                <div class="metric-subtitle" id="components-breakdown">Nodes & Relayers</div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Healthy Components</div>
                    <svg class="metric-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                    </svg>
                </div>
                <div class="metric-value" id="healthy-components">-</div>
                <div class="metric-subtitle" id="health-percentage">-% operational</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="health-progress" style="width: 0%"></div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Scheduled Operations</div>
                    <svg class="metric-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                    </svg>
                </div>
                <div class="metric-value" id="scheduled-operations">-</div>
                <div class="metric-subtitle" id="next-operation-time">Next: Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Active Servers</div>
                    <svg class="metric-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 002 2H4a2 2 0 01-2-2V5zm3 1h6v4H5V6zm6 6H5v2h6v-2z"/>
                    </svg>
                </div>
                <div class="metric-value" id="active-servers">-</div>
                <div class="metric-subtitle" id="server-connections">- SSH connections</div>
            </div>
        </div>

        <!-- Blockchain Nodes Table -->
        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">Blockchain Nodes</h2>
                <div class="panel-actions">
                    <button class="btn" onclick="forceHealthCheck()">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/>
                        </svg>
                        Refresh All
                    </button>
                </div>
            </div>
            <div class="panel-content">
                <div id="nodes-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading blockchain nodes...
                    </div>
                </div>
            </div>
        </div>

        <!-- Hermes Relayers Table -->
        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">Hermes Relayers</h2>
                <div class="panel-actions">
                    <button class="btn" onclick="refreshHermesStatus()">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/>
                        </svg>
                        Refresh All
                    </button>
                </div>
            </div>
            <div class="panel-content">
                <div id="hermes-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading Hermes relayers...
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        let refreshInterval;
        let nodeConfigs = {};
        let hermesConfigs = {};
        let scheduledOperations = {};
        let snapshotStats = {};
        let isLoadingData = false;

        // Store data globally to calculate metrics correctly
        let currentNodesData = null;
        let currentHermesData = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            startAutoRefresh();
        });

        function startAutoRefresh() {
            refreshInterval = setInterval(loadAllData, 30000);
        }

        async function loadAllData() {
            // Prevent overlapping load operations to reduce flickering
            if (isLoadingData) return;
            isLoadingData = true;

            try {
                // Load configs and scheduled operations first
                await Promise.all([
                    loadNodeConfigs(),
                    loadHermesConfigs(),
                    loadScheduledOperations()
                ]);

                // Load snapshot stats completely before proceeding
                await loadSnapshotStats();

                // Then load UI data that depends on the configs
                await Promise.all([
                    loadNodes(),
                    loadHermesInstances()
                ]);

                // Calculate metrics after both datasets are loaded
                updateAllMetrics();
                updateLastUpdated();
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Failed to load data: ' + error.message, 'error');
            } finally {
                isLoadingData = false;
            }
        }

        async function loadNodeConfigs() {
            try {
                const response = await fetch('/api/config/nodes');
                const data = await response.json();
                if (data.success) {
                    nodeConfigs = data.data.nodes || {};
                }
            } catch (error) {
                console.error('Failed to load node configs:', error);
            }
        }

        async function loadHermesConfigs() {
            try {
                const response = await fetch('/api/config/hermes');
                const data = await response.json();
                if (data.success) {
                    hermesConfigs = data.data.hermes || {};
                }
            } catch (error) {
                console.error('Failed to load hermes configs:', error);
            }
        }

        async function loadScheduledOperations() {
            try {
                const response = await fetch('/api/maintenance/schedule');
                const data = await response.json();
                if (data.success) {
                    // Create a lookup for scheduled operations by target name
                    scheduledOperations = {};
                    if (data.data.scheduled) {
                        data.data.scheduled.forEach(op => {
                            if (!scheduledOperations[op.target_name]) {
                                scheduledOperations[op.target_name] = [];
                            }
                            scheduledOperations[op.target_name].push(op);
                        });
                    }
                    updateScheduleMetrics(data.data);
                }
            } catch (error) {
                console.error('Failed to load scheduled operations:', error);
            }
        }

        async function loadSnapshotStats() {
            try {
                const newSnapshotStats = {};
                const statPromises = [];

                // Load stats for snapshot-enabled nodes in parallel but wait for all
                for (const [nodeName, nodeConfig] of Object.entries(nodeConfigs)) {
                    if (nodeConfig.snapshots_enabled) {
                        const promise = fetch(`/api/snapshots/${nodeName}/stats`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    newSnapshotStats[nodeName] = data.data;
                                }
                            })
                            .catch(error => {
                                console.warn(`Failed to load snapshot stats for ${nodeName}:`, error);
                            });
                        statPromises.push(promise);
                    }
                }

                // Wait for all stats to load before updating
                await Promise.all(statPromises);
                snapshotStats = newSnapshotStats;
            } catch (error) {
                console.error('Failed to load snapshot stats:', error);
            }
        }

        async function loadNodes() {
            try {
                const response = await fetch('/api/nodes/health');
                const data = await response.json();

                if (data.success) {
                    currentNodesData = data.data;
                    displayNodes(data.data);
                } else {
                    throw new Error('Failed to load node data');
                }
            } catch (error) {
                currentNodesData = null;
                document.getElementById('nodes-container').innerHTML =
                    '<div class="alert alert-error">Failed to load blockchain nodes: ' + error.message + '</div>';
            }
        }

        async function loadHermesInstances() {
            try {
                const response = await fetch('/api/hermes/instances');
                const data = await response.json();

                if (data.success) {
                    currentHermesData = data.data;
                    displayHermesInstances(data.data);
                } else {
                    throw new Error('Failed to load Hermes data');
                }
            } catch (error) {
                currentHermesData = null;
                document.getElementById('hermes-container').innerHTML =
                    '<div class="alert alert-error">Failed to load Hermes relayers: ' + error.message + '</div>';
            }
        }

        // Function to calculate all metrics with proper data
        function updateAllMetrics() {
            const nodes = currentNodesData || [];
            const hermesInstances = currentHermesData || [];

            const totalNodes = nodes.length;
            const totalHermes = hermesInstances.length;
            const totalComponents = totalNodes + totalHermes;

            const healthyNodes = nodes.filter(n => n.status === 'Healthy').length;
            const healthyHermes = hermesInstances.filter(h => {
                const status = h.status || '';
                return status.toLowerCase().includes('active');
            }).length;
            const healthyComponents = healthyNodes + healthyHermes;

            const maintenanceNodes = nodes.filter(n => n.status === 'Maintenance').length;
            const healthPercentage = totalComponents > 0 ? Math.round((healthyComponents / totalComponents) * 100) : 0;

            // Update DOM elements
            document.getElementById('total-components').textContent = totalComponents;
            document.getElementById('components-breakdown').textContent = `${totalNodes} Nodes, ${totalHermes} Relayers`;
            document.getElementById('healthy-components').textContent = healthyComponents;
            document.getElementById('health-percentage').textContent = `${healthPercentage}% operational`;
            document.getElementById('health-progress').style.width = `${healthPercentage}%`;

            // Update system status indicator
            const statusElement = document.getElementById('system-status');
            const statusText = statusElement.querySelector('span');

            if (maintenanceNodes > 0) {
                statusElement.className = 'status-indicator maintenance';
                statusText.textContent = `${maintenanceNodes} Component${maintenanceNodes > 1 ? 's' : ''} in Maintenance`;
            } else if (healthPercentage === 100) {
                statusElement.className = 'status-indicator healthy';
                statusText.textContent = 'All Systems Operational';
            } else if (healthPercentage >= 80) {
                statusElement.className = 'status-indicator warning';
                statusText.textContent = 'Some Issues Detected';
            } else {
                statusElement.className = 'status-indicator error';
                statusText.textContent = 'Critical Issues';
            }

            // Update server metrics
            document.getElementById('active-servers').textContent = Object.keys(nodeConfigs || {}).length > 0 ?
                new Set(Object.values(nodeConfigs).map(n => n.server_host)).size : '-';
            document.getElementById('server-connections').textContent = 'Active connections';
        }

        function displayNodes(nodes) {
            const container = document.getElementById('nodes-container');

            if (!nodes || nodes.length === 0) {
                container.innerHTML = '<div class="loading">No blockchain nodes configured</div>';
                return;
            }

            // Sort nodes by server and then by name
            const sortedNodes = [...nodes].sort((a, b) => {
                const serverA = getServerFromNodeName(a.node_name);
                const serverB = getServerFromNodeName(b.node_name);
                if (serverA !== serverB) {
                    return serverA.localeCompare(serverB);
                }
                return a.node_name.localeCompare(b.node_name);
            });

            const tableHtml = `
                <table class="infrastructure-table">
                    <tbody>
                        ${sortedNodes.map(node => {
                            const nodeConfig = nodeConfigs[node.node_name] || {};
                            const nodeSchedules = scheduledOperations[node.node_name] || [];
                            const nodeSnapshots = snapshotStats[node.node_name];

                            const isPruningEnabled = nodeConfig.pruning_enabled;
                            const isSnapshotEnabled = nodeConfig.snapshots_enabled;
                            const isAutoRestoreEnabled = nodeConfig.auto_restore_enabled;
                            const hasScheduledSnapshots = nodeConfig.snapshot_schedule;
                            const isInMaintenance = node.status === 'Maintenance';

                            return `
                                <tr onclick="showNodeDetails('${node.node_name}')" style="cursor: pointer;">
                                    <td onclick="event.stopPropagation();">
                                        <div class="component-name-primary">${formatNodeName(node.node_name)}</div>
                                        <div class="component-name-technical">${node.node_name}</div>
                                        <div class="server-name" style="margin-top: 0.25rem;">Server: ${getServerFromNodeName(node.node_name)}</div>

                                        ${isSnapshotEnabled ? `
                                            <div class="snapshot-info">
                                                Snapshots: LZ4 Compressed
                                                <div class="snapshot-features">
                                                    ${hasScheduledSnapshots ? '<span class="snapshot-feature">Scheduled</span>' : ''}
                                                    ${isAutoRestoreEnabled ? '<span class="snapshot-feature">Auto-Restore</span>' : ''}
                                                    <span class="snapshot-feature">${nodeSnapshots ? nodeSnapshots.total_snapshots : 0} saved</span>
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${node.error_message && node.status !== 'Maintenance' ?
                                            `<div class="error-message">${node.error_message}</div>` : ''}
                                        ${node.maintenance_info ? renderMaintenanceDetails(node.maintenance_info, node.node_name) : ''}
                                    </td>
                                    <td onclick="event.stopPropagation();">
                                        <div class="node-status-badge status-${node.status.toLowerCase()}">
                                            <div class="status-dot-small"></div>
                                            ${node.status}
                                        </div>
                                    </td>
                                    <td onclick="event.stopPropagation();">
                                        <div class="block-height">${node.latest_block_height || 'Unknown'}</div>
                                        <div style="font-size: 0.75rem; margin-top: 0.25rem;">
                                            ${node.catching_up !== null ?
                                                (node.catching_up ?
                                                    '<span style="color: var(--warning-color); font-weight: 500;">Catching Up</span>' :
                                                    '<span style="color: var(--success-color); font-weight: 500;">Synced</span>') :
                                                '<span style="color: var(--text-muted);">Unknown</span>'
                                            }
                                        </div>
                                    </td>
                                    <td onclick="event.stopPropagation();">
                                        ${renderMultipleSchedules(node.node_name, nodeConfig)}
                                    </td>
                                    <td onclick="event.stopPropagation();">
                                        ${renderNextRunTimes(node.node_name, nodeConfig)}
                                    </td>
                                    <td onclick="event.stopPropagation();">
                                        <div class="action-buttons">
                                            ${isPruningEnabled && !isInMaintenance ? `
                                                <button class="btn btn-icon btn-warning"
                                                        onclick="executeManualPruning('${node.node_name}')"
                                                        title="Run pruning now">
                                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/>
                                                    </svg>
                                                    <div class="tooltip">Run Pruning</div>
                                                </button>
                                            ` : ''}

                                            ${isSnapshotEnabled && !isInMaintenance ? `
                                                <button class="btn btn-icon btn-snapshot"
                                                        onclick="executeCreateSnapshot('${node.node_name}')"
                                                        title="Create snapshot now">
                                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"/>
                                                        <path d="M3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6z"/>
                                                    </svg>
                                                    <div class="tooltip">Create Snapshot</div>
                                                </button>

                                                <button class="btn btn-icon btn-primary"
                                                        onclick="executeRestoreSnapshot('${node.node_name}')"
                                                        title="Restore from latest snapshot">
                                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1z"/>
                                                    </svg>
                                                    <div class="tooltip">Restore Snapshot</div>
                                                </button>
                                            ` : ''}

                                            ${isInMaintenance && node.maintenance_info ? `
                                                <button class="btn btn-icon btn-cancel"
                                                        onclick="cancelMaintenanceOperation('${node.node_name}')"
                                                        title="Cancel maintenance operation">
                                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                                                    </svg>
                                                    <div class="tooltip">Cancel Operation</div>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHtml;
        }

        function renderMultipleSchedules(nodeName, nodeConfig) {
            const schedules = [];

            // Check for pruning schedule
            if (nodeConfig.pruning_enabled && nodeConfig.pruning_schedule) {
                const scheduleInfo = parseCronExpression(nodeConfig.pruning_schedule);
                schedules.push({
                    type: 'Pruning',
                    schedule: nodeConfig.pruning_schedule,
                    readable: scheduleInfo.readable,
                    class: 'pruning'
                });
            }

            // Check for snapshot schedule
            if (nodeConfig.snapshots_enabled && nodeConfig.snapshot_schedule) {
                const scheduleInfo = parseCronExpression(nodeConfig.snapshot_schedule);
                schedules.push({
                    type: 'Snapshot',
                    schedule: nodeConfig.snapshot_schedule,
                    readable: scheduleInfo.readable,
                    class: 'snapshot'
                });
            }

            if (schedules.length === 0) {
                return '<div class="no-schedule">No schedules</div>';
            }

            if (schedules.length === 1) {
                return `
                    <div class="schedule-info">
                        <div class="schedule-readable">${schedules[0].readable}</div>
                        <div class="schedule-cron">${schedules[0].schedule}</div>
                        <div style="font-size: 0.7rem; color: var(--accent-color); margin-top: 0.25rem;">${schedules[0].type}</div>
                    </div>
                `;
            }

            return `
                <div class="multiple-schedules">
                    ${schedules.map(sched => `
                        <div class="schedule-item ${sched.class}">
                            <div class="schedule-type">${sched.type}</div>
                            <div class="schedule-details">
                                <div style="font-weight: 500; margin-bottom: 0.25rem;">${sched.readable}</div>
                                <div style="font-family: monospace; font-size: 0.7rem; color: var(--text-muted);">${sched.schedule}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderNextRunTimes(nodeName, nodeConfig) {
            const nextRuns = [];

            // Find scheduled operations for this node
            const nodeSchedules = scheduledOperations[nodeName] || [];

            // Look for pruning schedule
            if (nodeConfig.pruning_enabled && nodeConfig.pruning_schedule) {
                const pruningOp = nodeSchedules.find(op => op.operation_type === 'NodePruning' || op.operation_type === 'pruning');
                if (pruningOp && pruningOp.next_run) {
                    nextRuns.push({
                        type: 'Pruning',
                        next_run: pruningOp.next_run
                    });
                }
            }

            // Look for snapshot schedule
            if (nodeConfig.snapshots_enabled && nodeConfig.snapshot_schedule) {
                const snapshotOp = nodeSchedules.find(op => op.operation_type === 'SnapshotCreation' || op.operation_type === 'snapshot_creation');
                if (snapshotOp && snapshotOp.next_run) {
                    nextRuns.push({
                        type: 'Snapshot',
                        next_run: snapshotOp.next_run
                    });
                }
            }

            if (nextRuns.length === 0) {
                return '<div class="no-schedule">-</div>';
            }

            if (nextRuns.length === 1) {
                return `
                    <div class="next-run">
                        <div class="next-run-time">${formatNextRun(nextRuns[0].next_run)}</div>
                        <div class="next-run-countdown">${getTimeUntil(nextRuns[0].next_run)}</div>
                    </div>
                `;
            }

            return `
                <div class="multiple-schedules">
                    ${nextRuns.map(run => `
                        <div class="schedule-item">
                            <div class="schedule-type">${run.type}</div>
                            <div class="schedule-details">
                                <div style="font-weight: 500; margin-bottom: 0.25rem;">${formatNextRun(run.next_run)}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${getTimeUntil(run.next_run)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayHermesInstances(hermesInstances) {
            const container = document.getElementById('hermes-container');

            if (!hermesInstances || hermesInstances.length === 0) {
                container.innerHTML = '<div class="loading">No Hermes relayers configured</div>';
                return;
            }

            // Sort Hermes instances by server and then by name
            const sortedHermes = [...hermesInstances].sort((a, b) => {
                if (a.server_host !== b.server_host) {
                    return a.server_host.localeCompare(b.server_host);
                }
                return a.name.localeCompare(b.name);
            });

            const tableHtml = `
                <table class="infrastructure-table">
                    <tbody>
                        ${sortedHermes.map(hermes => {
                            const scheduledOp = (scheduledOperations[hermes.name] || [])[0];
                            const statusClass = hermes.status ? getHermesStatusClass(hermes.status) : 'status-unknown';

                            return `
                                <tr onclick="showHermesDetails('${hermes.name}')" style="cursor: pointer;">
                                    <td onclick="event.stopPropagation();">
                                        <div class="component-name-primary">${formatHermesName(hermes.name)}</div>
                                        <div class="component-name-technical">${hermes.name}</div>
                                        <div class="server-name" style="margin-top: 0.25rem;">Server: ${hermes.server_host}</div>
                                        ${hermes.dependent_nodes && hermes.dependent_nodes.length > 0 ? `
                                            <div class="hermes-dependent-nodes">
                                                Depends on: ${hermes.dependent_nodes.map(node => formatDependencyName(node)).join(', ')}
                                            </div>
                                        ` : ''}
                                        ${hermes.uptime_formatted ? `
                                            <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--text-secondary);">
                                                Uptime: ${hermes.uptime_formatted}
                                            </div>
                                        ` : ''}
                                    </td>
                                    <td onclick="event.stopPropagation();">
                                        <div class="node-status-badge ${statusClass}">
                                            <div class="status-dot-small"></div>
                                            ${formatHermesStatus(hermes.status)}
                                        </div>
                                    </td>
                                    <td onclick="event.stopPropagation();">
                                        ${scheduledOp ? renderScheduleInfo(scheduledOp) : '<div class="no-schedule">No schedule</div>'}
                                    </td>
                                    <td onclick="event.stopPropagation();">
                                        ${scheduledOp ? renderNextRun(scheduledOp) : '<div class="no-schedule">-</div>'}
                                    </td>
                                    <td onclick="event.stopPropagation();">
                                        <div class="action-buttons">
                                            <button class="btn btn-icon btn-hermes"
                                                    onclick="executeManualHermesRestart('${hermes.name}')"
                                                    title="Restart Hermes now">
                                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/>
                                                </svg>
                                                <div class="tooltip">Restart Hermes</div>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHtml;
        }

        // Action functions
        async function executeCreateSnapshot(nodeName) {
            const nodeDisplayName = formatNodeName(nodeName);

            if (!confirm(`Create LZ4 Snapshot Confirmation\n\nCreate snapshot for ${nodeDisplayName}?\n\n Node service will be stopped\n Data will be compressed with LZ4\n Service will be restarted\n This may take 30-120 minutes\n\nProceed with snapshot creation?`)) {
                return;
            }

            try {
                showAlert(`Creating LZ4 snapshot for ${nodeDisplayName}...`, 'warning');

                const response = await fetch(`/api/snapshots/${nodeName}/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`Snapshot creation initiated for ${nodeDisplayName}`, 'success');
                    loadAllData();
                } else {
                    throw new Error(data.message || 'Failed to create snapshot');
                }
            } catch (error) {
                showAlert('Snapshot creation failed: ' + error.message, 'error');
            }
        }

        async function executeRestoreSnapshot(nodeName) {
            const nodeDisplayName = formatNodeName(nodeName);

            if (!confirm(`Restore Snapshot Confirmation\n\nRestore latest snapshot for ${nodeDisplayName}?\n\n Node service will be stopped\n Latest snapshot will be restored\n Service will be restarted\n This may take 15-45 minutes\n\nProceed with snapshot restore?`)) {
                return;
            }

            try {
                showAlert(`Restoring latest snapshot for ${nodeDisplayName}...`, 'warning');

                const response = await fetch(`/api/snapshots/${nodeName}/restore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`Snapshot restore initiated for ${nodeDisplayName}`, 'success');
                    loadAllData();
                } else {
                    throw new Error(data.message || 'Failed to restore snapshot');
                }
            } catch (error) {
                showAlert('Snapshot restore failed: ' + error.message, 'error');
            }
        }

        async function executeManualPruning(targetName) {
            const nodeDisplayName = formatNodeName(targetName);

            if (!confirm(`Manual Pruning Confirmation\n\nExecute pruning for ${nodeDisplayName}?\n\n This will stop the node service\n Data will be pruned according to configuration\n Service will be restarted after completion\n This may take 15-30 minutes\n\nProceed with manual pruning?`)) {
                return;
            }

            try {
                showAlert(`Starting manual pruning for ${nodeDisplayName}...`, 'warning');

                const response = await fetch('/api/maintenance/run-now', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation_type: 'pruning',
                        target_name: targetName,
                        schedule: 'manual'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`Manual pruning initiated for ${nodeDisplayName}`, 'success');
                    loadAllData();
                } else {
                    throw new Error(data.message || 'Failed to start manual pruning');
                }
            } catch (error) {
                showAlert('Manual pruning failed: ' + error.message, 'error');
            }
        }

        async function executeManualHermesRestart(targetName) {
            const hermesDisplayName = formatHermesName(targetName);

            if (!confirm(`Manual Hermes Restart Confirmation\n\nRestart Hermes instance: ${hermesDisplayName}?\n\n Hermes service will be stopped\n Dependencies will be checked\n Service will be restarted\n This may take 2-5 minutes\n\nProceed with manual restart?`)) {
                return;
            }

            try {
                showAlert(`Starting manual Hermes restart for ${hermesDisplayName}...`, 'warning');

                const response = await fetch('/api/maintenance/run-now', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation_type: 'hermes_restart',
                        target_name: targetName,
                        schedule: 'manual'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`Manual Hermes restart completed for ${hermesDisplayName}`, 'success');
                    loadAllData();
                } else {
                    throw new Error(data.message || 'Failed to restart Hermes');
                }
            } catch (error) {
                showAlert('Manual Hermes restart failed: ' + error.message, 'error');
            }
        }

        async function cancelMaintenanceOperation(nodeName) {
            const nodeDisplayName = formatNodeName(nodeName);

            if (!confirm(`Cancel Maintenance Operation\n\nCancel ongoing maintenance for ${nodeDisplayName}?\n\n This will attempt to stop the current operation\n The service may need manual intervention\n Use with caution\n\nProceed with cancellation?`)) {
                return;
            }

            try {
                showAlert(`Canceling maintenance operation for ${nodeDisplayName}...`, 'warning');

                const response = await fetch(`/api/maintenance/clear/${nodeName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`Maintenance operation canceled for ${nodeDisplayName}`, 'success');
                    loadAllData();
                } else {
                    throw new Error(data.message || 'Failed to cancel maintenance');
                }
            } catch (error) {
                showAlert('Failed to cancel maintenance: ' + error.message, 'error');
            }
        }

        async function forceHealthCheck() {
            try {
                showAlert('Initiating comprehensive health check...', 'success');

                const nodeNames = Object.keys(nodeConfigs);
                let completedChecks = 0;

                for (const nodeName of nodeNames) {
                    try {
                        await fetch(`/api/nodes/${nodeName}/check`, { method: 'POST' });
                        completedChecks++;
                    } catch (error) {
                        console.warn(`Health check failed for node ${nodeName}:`, error);
                    }
                }

                showAlert(`Health check completed: ${completedChecks}/${nodeNames.length} nodes checked successfully`, 'success');
                loadNodes();
            } catch (error) {
                showAlert('Health check operation failed: ' + error.message, 'error');
            }
        }

        async function refreshHermesStatus() {
            try {
                showAlert('Refreshing Hermes status...', 'success');
                await loadHermesInstances();
                showAlert('Hermes status refreshed', 'success');
            } catch (error) {
                showAlert('Hermes refresh failed: ' + error.message, 'error');
            }
        }

        // Helper functions
        function getHermesStatusClass(status) {
            const cleanStatus = status.replace(/[()]/g, '').toLowerCase();
            if (cleanStatus.includes('active')) return 'status-active';
            if (cleanStatus.includes('inactive') || cleanStatus.includes('failed')) return 'status-inactive';
            return 'status-unknown';
        }

        function formatHermesStatus(status) {
            if (!status) return 'Unknown';
            return status.replace(/[()]/g, '');
        }

        function formatHermesName(technicalName) {
            if (!technicalName) return technicalName;

            const parts = technicalName.split('-');
            if (parts.length < 2) return technicalName;

            const serverName = parts[0];
            const serviceName = parts[1];

            const formatPart = (part) => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();

            return `${formatPart(serverName)} ${formatPart(serviceName)}`;
        }

        function renderScheduleInfo(scheduledOp) {
            const scheduleInfo = parseCronExpression(scheduledOp.schedule);
            const operationType = formatOperationType(scheduledOp.operation_type);

            return `
                <div class="schedule-info">
                    <div class="schedule-readable">${scheduleInfo.readable}</div>
                    <div class="schedule-cron">${scheduledOp.schedule}</div>
                    <div style="font-size: 0.7rem; color: var(--accent-color); margin-top: 0.25rem;">${operationType}</div>
                </div>
            `;
        }

        function renderNextRun(scheduledOp) {
            if (!scheduledOp.next_run) {
                return '<div class="no-schedule">Not scheduled</div>';
            }

            return `
                <div class="next-run">
                    <div class="next-run-time">${formatNextRun(scheduledOp.next_run)}</div>
                    <div class="next-run-countdown">${getTimeUntil(scheduledOp.next_run)}</div>
                </div>
            `;
        }

        function renderMaintenanceDetails(maintenance, nodeName) {
            return `
                <div class="maintenance-details">
                    <div style="font-weight: 600; color: var(--maintenance-color); margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 0.375rem;">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/>
                            </svg>
                            ${maintenance.operation_type} in progress
                        </div>
                    </div>
                    <div style="color: var(--text-muted); margin-bottom: 0.5rem; font-size: 0.7rem;">
                        Started: ${formatTime(maintenance.started_at)}
                    </div>
                    <div class="maintenance-progress">
                        <div class="maintenance-progress-bar">
                            <div class="maintenance-progress-fill" style="width: 20%"></div>
                        </div>
                        <div class="maintenance-progress-text">
                            Running for ${maintenance.elapsed_minutes}m
                        </div>
                    </div>
                </div>
            `;
        }

        function updateScheduleMetrics(scheduleData) {
            const scheduled = scheduleData.scheduled || [];
            const totalScheduled = scheduled.length;

            document.getElementById('scheduled-operations').textContent = totalScheduled;

            // Find next operation time
            let nextOperation = null;
            let nextTime = null;

            scheduled.forEach(op => {
                if (op.next_run) {
                    const opTime = new Date(op.next_run);
                    if (!nextTime || opTime < nextTime) {
                        nextTime = opTime;
                        nextOperation = op;
                    }
                }
            });

            const nextOpElement = document.getElementById('next-operation-time');
            if (nextOperation) {
                nextOpElement.textContent = `Next: ${getTimeUntil(nextOperation.next_run)}`;
            } else {
                nextOpElement.textContent = 'No operations scheduled';
            }
        }

        function showNodeDetails(nodeName) {
            console.log('Show details for node:', nodeName);
        }

        function showHermesDetails(hermesName) {
            console.log('Show details for hermes:', hermesName);
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'Never';

            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 0) {
                const absDiff = Math.abs(diff);
                if (absDiff < 60000) return 'In less than a minute';
                if (absDiff < 3600000) return `In ${Math.floor(absDiff / 60000)} minutes`;
                if (absDiff < 86400000) return `In ${Math.floor(absDiff / 3600000)} hours`;
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }

            if (diff < 3600000) return Math.floor(diff / 60000) + ' minutes ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' hours ago';

            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function formatNextRun(timestamp) {
            if (!timestamp) return 'Not scheduled';

            const date = new Date(timestamp);
            const now = new Date();
            const diff = date - now;

            if (diff <= 0) return 'Overdue';

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            if (days > 0) {
                return `${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else if (hours > 0) {
                return `Today at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else {
                return `In ${minutes} minute${minutes !== 1 ? 's' : ''}`;
            }
        }

        function formatDependencyName(nodeName) {
            if (!nodeName) return nodeName;

            // Extract just the network name from formats like "discovery-osmosis-1"
            const parts = nodeName.split('-');
            if (parts.length >= 2) {
                const networkName = parts[1]; // Get the network part

                const networkMap = {
                    'osmosis': 'Osmosis',
                    'neutron': 'Neutron',
                    'nolus': 'Nolus',
                    'vitosha': 'Vitosha',
                    'rila': 'Rila',
                    'pion': 'Pion',
                    'pirin': 'Pirin'
                };

                return networkMap[networkName.toLowerCase()] || networkName.charAt(0).toUpperCase() + networkName.slice(1).toLowerCase();
            }

            return nodeName;
        }

        function formatNodeName(technicalName) {
            if (!technicalName) return technicalName;

            const parts = technicalName.split('-');
            if (parts.length < 2) return technicalName;

            const serverName = parts[0];
            const networkName = parts[1];

            const formatPart = (part) => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();

            const networkMap = {
                'osmosis': 'Osmosis',
                'neutron': 'Neutron',
                'vitosha': 'Vitosha',
                'rila': 'Rila',
                'pion': 'Pion',
                'pirin': 'Pirin'
            };

            const formattedServer = formatPart(serverName);
            const formattedNetwork = networkMap[networkName.toLowerCase()] || formatPart(networkName);

            return `${formattedServer} ${formattedNetwork}`;
        }

        function getServerFromNodeName(nodeName) {
            if (!nodeName) return 'Unknown';
            const parts = nodeName.split('-');
            return parts[0] ? parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase() : 'Unknown';
        }

        function updateLastUpdated() {
            document.getElementById('last-updated').textContent =
                'Last updated: ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        }

        function showAlert(message, type) {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            const mainContainer = document.querySelector('.main-container');
            mainContainer.insertBefore(alertDiv, mainContainer.firstChild);

            setTimeout(() => alertDiv.remove(), type === 'error' ? 8000 : 5000);
        }

        // Cron expression parsing and formatting functions
        function parseCronExpression(cronExpr) {
            const parts = cronExpr.trim().split(/\s+/);

            if (parts.length !== 6) {
                return { readable: 'Invalid schedule', frequency: 'unknown' };
            }

            const [sec, min, hour, day, month, weekday] = parts;

            if (weekday !== '*' && day === '*' && month === '*') {
                const weekdayName = getWeekdayName(weekday);
                const timeStr = formatTime24(hour, min);
                return {
                    readable: `Every ${weekdayName} at ${timeStr}`,
                    frequency: 'weekly'
                };
            }

            if (weekday === '*' && day === '*' && month === '*') {
                const timeStr = formatTime24(hour, min);
                return {
                    readable: `Daily at ${timeStr}`,
                    frequency: 'daily'
                };
            }

            if (day !== '*' && month === '*' && weekday === '*') {
                const timeStr = formatTime24(hour, min);
                const dayStr = getDayWithSuffix(day);
                return {
                    readable: `Monthly on the ${dayStr} at ${timeStr}`,
                    frequency: 'monthly'
                };
            }

            return {
                readable: 'Custom schedule',
                frequency: 'custom'
            };
        }

        function getWeekdayName(weekdayValue) {
            const weekdays = {
                '0': 'Sunday',
                '1': 'Monday',
                '2': 'Tuesday',
                '3': 'Wednesday',
                '4': 'Thursday',
                '5': 'Friday',
                '6': 'Saturday',
                '7': 'Sunday'
            };
            return weekdays[weekdayValue] || `Day ${weekdayValue}`;
        }

        function formatTime24(hour, minute) {
            const h = hour === '*' ? '00' : hour.padStart(2, '0');
            const m = minute === '*' ? '00' : minute.padStart(2, '0');

            const hour24 = parseInt(h);
            const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
            const ampm = hour24 >= 12 ? 'PM' : 'AM';

            return `${hour12}:${m} ${ampm}`;
        }

        function getDayWithSuffix(day) {
            if (day === '*') return 'every day';

            const dayNum = parseInt(day);
            const suffix = getDaySuffix(dayNum);
            return `${dayNum}${suffix}`;
        }

        function getDaySuffix(day) {
            if (day >= 11 && day <= 13) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        function formatOperationType(opType) {
            const types = {
                'NodePruning': 'Node Pruning',
                'HermesRestart': 'Hermes Restart',
                'SystemMaintenance': 'System Maintenance',
                'SnapshotCreation': 'Snapshot Creation'
            };
            return types[opType] || opType.replace(/([A-Z])/g, ' $1').trim();
        }

        function getTimeUntil(targetTime) {
            const now = new Date();
            const target = new Date(targetTime);
            const diff = target - now;

            if (diff <= 0) {
                return 'Overdue';
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            if (days > 0) {
                return `in ${days} day${days > 1 ? 's' : ''}, ${hours}h`;
            } else if (hours > 0) {
                return `in ${hours}h ${minutes}m`;
            } else {
                return `in ${minutes} minute${minutes !== 1 ? 's' : ''}`;
            }
        }
    </script>
</body>
</html>
